//
//  AppDelegate.swift
//  Hohma
//
//  Created by Artem Vydro on 06.08.2025.
//

import UIKit
import UserNotifications

class AppDelegate: NSObject, UIApplicationDelegate {

    func application(
        _ application: UIApplication,
        didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]? = nil
    ) -> Bool {

        print("üîó AppDelegate: didFinishLaunchingWithOptions called")

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        setupPushNotifications()

        // –õ–æ–≥–∏—Ä—É–µ–º launch options –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        if let url = launchOptions?[.url] as? URL {
            print("üîó AppDelegate: ===== APP LAUNCHED WITH URL =====")
            print("üîó AppDelegate: App launched with URL: \(url)")
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º URL –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
                print("üîó AppDelegate: Processing launch URL after delay")
                _ = self.handleCustomURL(url: url)
            }
        } else if let userActivity = launchOptions?[.userActivityDictionary] as? [String: Any],
            let userActivityObject = userActivity["UIApplicationLaunchOptionsUserActivityKey"]
                as? NSUserActivity,
            let url = userActivityObject.webpageURL
        {
            print("üîó AppDelegate: ===== APP LAUNCHED WITH USER ACTIVITY =====")
            print("üîó AppDelegate: App launched with userActivity URL: \(url)")
            DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
                print("üîó AppDelegate: Processing launch userActivity URL after delay")
                _ = self.handleCustomURL(url: url)
            }
        } else {
            print("üîó AppDelegate: App launched without URL or userActivity")
        }

        print("üîó AppDelegate: AppDelegate setup complete")

        return true
    }

    private func setupPushNotifications() {
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º—Å—è –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        UIApplication.shared.registerForRemoteNotifications()
    }

    // MARK: - Universal Links & Deep Linking

    func application(
        _ application: UIApplication,
        continue userActivity: NSUserActivity,
        restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void
    ) -> Bool {
        print("üîó AppDelegate: ===== USER ACTIVITY RECEIVED =====")
        print("üîó AppDelegate: Received userActivity: \(userActivity.activityType)")
        print(
            "üîó AppDelegate: UserActivity URL: \(userActivity.webpageURL?.absoluteString ?? "nil")")
        print("üîó AppDelegate: UserActivity userInfo: \(userActivity.userInfo ?? [:])")

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Universal Links
        if userActivity.activityType == NSUserActivityTypeBrowsingWeb,
            let url = userActivity.webpageURL
        {
            print("üîó AppDelegate: ‚úÖ Processing Universal Link")
            return handleUniversalLink(url: url)
        }

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º custom URL schemes —á–µ—Ä–µ–∑ userActivity
        // –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ
        if let url = userActivity.webpageURL {
            print("üîó AppDelegate: ‚úÖ Processing custom URL scheme through userActivity")
            return handleCustomURL(url: url)
        }

        print("üîó AppDelegate: ‚ùå Not a Universal Link or custom URL")
        print("üîó AppDelegate: ===== USER ACTIVITY PROCESSING COMPLETE =====")
        return false
    }

    func application(
        _ app: UIApplication,
        open url: URL,
        options: [UIApplication.OpenURLOptionsKey: Any] = [:]
    ) -> Bool {
        print("üîó AppDelegate: ===== DEEP LINK RECEIVED (application:open:options) =====")
        print("üîó AppDelegate: Received custom URL: \(url)")
        print("üîó AppDelegate: URL scheme: \(url.scheme ?? "nil")")
        print("üîó AppDelegate: URL host: \(url.host ?? "nil")")
        print("üîó AppDelegate: URL path: \(url.path)")
        print("üîó AppDelegate: URL pathComponents: \(url.pathComponents)")
        print("üîó AppDelegate: Full URL string: \(url.absoluteString)")
        print("üîó AppDelegate: Options: \(options)")
        print("üîó AppDelegate: App state: \(app.applicationState.rawValue)")

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º custom URL schemes
        let result = handleCustomURL(url: url)
        print("üîó AppDelegate: handleCustomURL returned: \(result)")
        print("üîó AppDelegate: ===== DEEP LINK PROCESSING COMPLETE =====")
        return result
    }

    private func handleUniversalLink(url: URL) -> Bool {
        print("üîó AppDelegate: Received Universal Link: \(url)")
        print("üîó AppDelegate: URL components: \(url.pathComponents)")

        // –ü–∞—Ä—Å–∏–º URL –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ID –∫–æ–ª–µ—Å–∞
        if let wheelId = extractWheelId(from: url) {
            print("üîó AppDelegate: Extracted wheel ID: \(wheelId)")
            print("üîó AppDelegate: Posting deepLinkToWheel notification")

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫ –∫–æ–ª–µ—Å—É
            NotificationCenter.default.post(
                name: .deepLinkToWheel,
                object: nil,
                userInfo: ["wheelId": wheelId]
            )
            print("üîó AppDelegate: Notification posted successfully")
            return true
        } else {
            print("üîó AppDelegate: Failed to extract wheel ID from URL")
        }

        return false
    }

    private func handleCustomURL(url: URL) -> Bool {
        print("üîó AppDelegate: ===== HANDLING CUSTOM URL =====")
        print("üîó AppDelegate: Received Custom URL: \(url)")
        print("üîó AppDelegate: URL scheme: \(url.scheme ?? "nil")")
        print("üîó AppDelegate: URL host: \(url.host ?? "nil")")
        print("üîó AppDelegate: URL path: \(url.path)")

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º custom URL schemes –¥–ª—è riqtu.Hohma:// –∏ hohma://
        if url.scheme == "riqtu.Hohma" || url.scheme == "hohma" {
            print("üîó AppDelegate: ‚úÖ URL scheme matches expected schemes")

            // –ü–∞—Ä—Å–∏–º URL –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ID –∫–æ–ª–µ—Å–∞
            if let wheelId = extractWheelId(from: url) {
                print("üîó AppDelegate: ‚úÖ Extracted wheel ID from custom URL: \(wheelId)")

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫ –∫–æ–ª–µ—Å—É
                print("üîó AppDelegate: üì§ Posting deepLinkToWheel notification...")
                NotificationCenter.default.post(
                    name: .deepLinkToWheel,
                    object: nil,
                    userInfo: ["wheelId": wheelId]
                )
                print("üîó AppDelegate: ‚úÖ Custom URL notification posted successfully")
                return true
            } else {
                print("üîó AppDelegate: ‚ùå Failed to extract wheel ID from custom URL")
            }
        }
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Universal Links —Å –¥–æ–º–µ–Ω–æ–º hohma.su
        else if url.scheme == "https" && url.host == "hohma.su" {
            print("üîó AppDelegate: ‚úÖ Processing Universal Link with hohma.su domain")
            return handleUniversalLink(url: url)
        } else {
            print(
                "üîó AppDelegate: ‚ùå URL scheme '\(url.scheme ?? "nil")' does not match expected schemes (riqtu.Hohma, hohma, or https)"
            )
        }

        print("üîó AppDelegate: ===== CUSTOM URL HANDLING COMPLETE =====")
        return false
    }

    private func extractWheelId(from url: URL) -> String? {
        print("üîó AppDelegate: Extracting wheel ID from URL: \(url)")
        print("üîó AppDelegate: URL scheme: \(url.scheme ?? "nil")")
        print("üîó AppDelegate: URL host: \(url.host ?? "nil")")
        print("üîó AppDelegate: URL path: \(url.path)")
        print("üîó AppDelegate: URL pathComponents: \(url.pathComponents)")

        let pathComponents = url.pathComponents
        print("üîó AppDelegate: Path components: \(pathComponents)")

        // –î–ª—è custom URL scheme: riqtu.Hohma://fortune-wheel/{wheelId}
        // host = "fortune-wheel", path = "/{wheelId}"
        if let host = url.host, host == "fortune-wheel" && pathComponents.count >= 2 {
            let wheelId = pathComponents[1]  // pathComponents[0] = "/", pathComponents[1] = wheelId
            print("üîó AppDelegate: Extracted wheel ID from custom scheme: \(wheelId)")
            return wheelId
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ wheelId –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ path –±–µ–∑ host
        // –ù–∞–ø—Ä–∏–º–µ—Ä: riqtu.Hohma:///fortune-wheel/{wheelId} –∏–ª–∏ riqtu.Hohma:///{wheelId}
        if pathComponents.count >= 2 {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ "fortune-wheel" –≤ path
            if let fortuneWheelIndex = pathComponents.firstIndex(of: "fortune-wheel"),
                fortuneWheelIndex + 1 < pathComponents.count
            {
                let wheelId = pathComponents[fortuneWheelIndex + 1]
                print("üîó AppDelegate: Extracted wheel ID from path with fortune-wheel: \(wheelId)")
                return wheelId
            }

            // –ï—Å–ª–∏ –Ω–µ—Ç "fortune-wheel", –Ω–æ –µ—Å—Ç—å ID –≤ path (–Ω–∞–ø—Ä–∏–º–µ—Ä, riqtu.Hohma:///{wheelId})
            if pathComponents.count == 2 && pathComponents[0] == "/" {
                let wheelId = pathComponents[1]
                print("üîó AppDelegate: Extracted wheel ID from simple path: \(wheelId)")
                return wheelId
            }
        }

        // –î–ª—è Universal Links: https://hohma.su/fortune-wheel/{wheelId}
        // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å "fortune-wheel" –≤ –ø—É—Ç–∏
        if let fortuneWheelIndex = pathComponents.firstIndex(of: "fortune-wheel"),
            fortuneWheelIndex + 1 < pathComponents.count
        {
            let wheelId = pathComponents[fortuneWheelIndex + 1]
            print("üîó AppDelegate: Extracted wheel ID from universal link: \(wheelId)")
            return wheelId
        }

        print("üîó AppDelegate: Failed to extract wheel ID")
        return nil
    }

    // MARK: - Push Notification Methods

    func application(
        _ application: UIApplication,
        didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data
    ) {
        // –ü–æ–ª—É—á–∞–µ–º device token –∏ –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –≤ —Å–µ—Ä–≤–∏—Å
        PushNotificationService.shared.setDeviceToken(deviceToken)
    }

    func application(
        _ application: UIApplication, didFailToRegisterForRemoteNotificationsWithError error: Error
    ) {
        print("‚ùå AppDelegate: Failed to register for remote notifications: \(error)")
    }

    func application(
        _ application: UIApplication, didReceiveRemoteNotification userInfo: [AnyHashable: Any],
        fetchCompletionHandler completionHandler: @escaping (UIBackgroundFetchResult) -> Void
    ) {

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        handleRemoteNotification(userInfo)

        // –í—ã–∑—ã–≤–∞–µ–º completion handler
        completionHandler(.newData)
    }

    private func handleRemoteNotification(_ userInfo: [AnyHashable: Any]) {
        print("üì± AppDelegate: Received remote notification: \(userInfo)")

        // –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if let aps = userInfo["aps"] as? [String: Any],
            let alert = aps["alert"] as? [String: Any],
            let title = alert["title"] as? String,
            let body = alert["body"] as? String
        {

            let type =
                PushNotificationType(rawValue: userInfo["type"] as? String ?? "general") ?? .general

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            PushNotificationService.shared.scheduleLocalNotification(
                type: type,
                title: title,
                body: body,
                userInfo: [:]
            )
        }
    }
}
